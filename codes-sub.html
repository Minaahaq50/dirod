<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة إدارة THE BEST</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<style>
body { font-family: 'Cairo', sans-serif; background: #141E30; color: white; padding: 20px; }
h1 { text-align: center; color: #00f5c4; margin-bottom: 20px; }
form { max-width: 400px; margin: 0 auto; text-align: center; }
input { width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: none; }
button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; }
button:hover { opacity: 0.9; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 12px; border-bottom: 1px solid #444; text-align: center; }
th { background-color: #0072ff; color: white; }
tr:hover { background-color: rgba(0, 197, 255, 0.2); }
button.approve { background-color: #00f5c4; color: #000; }
button.delete { background-color: #ff4f4f; color: #fff; margin-left: 5px; }
button.edit { background-color: #ffc107; color: #000; margin-left: 5px; }
button.add { background-color: #00ff7f; color: #000; margin-top:10px; }
#status { text-align:center; margin-bottom:10px; color:#00f5c4; }
#error { text-align:center; margin-bottom:10px; color:#ff4f4f; }
</style>
</head>
<body>

<h1>لوحة إدارة الطلبات</h1>

<div id="loginForm">
  <form id="adminLogin">
    <input type="email" id="adminEmail" placeholder="البريد الإلكتروني">
    <input type="password" id="adminPassword" placeholder="كلمة المرور">
    <button type="submit">تسجيل الدخول</button>
  </form>
</div>

<p id="status"></p>
<p id="error"></p>

<button id="addRequestBtn" class="add" style="display:none;">إضافة طلب جديد</button>

<table>
  <thead>
    <tr>
      <th>الاسم</th>
      <th>رقم الهاتف</th>
      <th>الوقت</th>
      <th>إجراءات</th>
    </tr>
  </thead>
  <tbody id="requestsTable">
  </tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdhj73cKJc2J2_tDHw2-89EemZx-EGMJQ",
  authDomain: "alamer-526ff.firebaseapp.com",
  databaseURL: "https://alamer-526ff-default-rtdb.firebaseio.com",
  projectId: "alamer-526ff",
  storageBucket: "alamer-526ff.appspot.com",
  messagingSenderId: "523879269039",
  appId: "1:523879269039:web:634861aa34641bfebf8a5a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const requestsTable = document.getElementById("requestsTable");
const statusEl = document.getElementById("status");
const errorEl = document.getElementById("error");
const loginFormDiv = document.getElementById("loginForm");
const addRequestBtn = document.getElementById("addRequestBtn");

// UID المسؤول
const adminUid = "Se5eNLTKoqUGjeShmRJRHDiKogF3";

document.getElementById("adminLogin").addEventListener("submit", e=>{
  e.preventDefault();
  const email = document.getElementById("adminEmail").value.trim();
  const password = document.getElementById("adminPassword").value.trim();
  errorEl.textContent = "";
  statusEl.textContent = "جارٍ تسجيل الدخول...";

  auth.signInWithEmailAndPassword(email,password)
  .then(res=>{
    if(res.user.uid !== adminUid){
      errorEl.textContent="❌ هذا الحساب ليس مسؤولاً.";
      auth.signOut();
      return;
    }
    statusEl.textContent="✅ تم تسجيل الدخول كمسؤول.";
    loginFormDiv.style.display="none";
    addRequestBtn.style.display="block";
    loadRequests();
  })
  .catch(err=>{
    errorEl.textContent="❌ فشل تسجيل الدخول. تحقق من البريد وكلمة المرور.";
    console.error(err);
  });
});

function loadRequests(){
  db.ref("pendingStudents").once("value")
  .then(snapshot=>{
    requestsTable.innerHTML="";
    if(!snapshot.exists()){
      requestsTable.innerHTML="<tr><td colspan='4'>لا توجد طلبات حالياً.</td></tr>";
      return;
    }
    snapshot.forEach(snap=>{
      const data = snap.val();
      const uid = snap.key;
      const row = document.createElement("tr");
      row.innerHTML=`
        <td>${data.name}</td>
        <td>${data.phone}</td>
        <td>${new Date(data.timestamp).toLocaleString()}</td>
        <td>
          <button class="approve">موافقة</button>
          <button class="edit">تعديل</button>
          <button class="delete">حذف</button>
        </td>
      `;

      row.querySelector(".approve").addEventListener("click", ()=>{
        db.ref("approvedStudents/"+uid).set(data)
        .then(()=> db.ref("pendingStudents/"+uid).remove())
        .then(()=>{ statusEl.textContent=`✅ تم الموافقة على ${data.name}`; loadRequests(); })
        .catch(err=>{ errorEl.textContent="❌ حدث خطأ أثناء الموافقة."; console.error(err); });
      });

      row.querySelector(".delete").addEventListener("click", ()=>{
        db.ref("pendingStudents/"+uid).remove()
        .then(()=>{ statusEl.textContent=`✅ تم حذف ${data.name}`; loadRequests(); })
        .catch(err=>{ errorEl.textContent="❌ حدث خطأ أثناء الحذف."; console.error(err); });
      });

      row.querySelector(".edit").addEventListener("click", ()=>{
        const newName = prompt("الاسم الجديد:", data.name);
        const newPhone = prompt("رقم الهاتف الجديد:", data.phone);
        if(newName && newPhone){
          db.ref("pendingStudents/"+uid).update({name:newName, phone:newPhone})
          .then(()=>{ statusEl.textContent=`✅ تم تعديل ${newName}`; loadRequests(); })
          .catch(err=>{ errorEl.textContent="❌ حدث خطأ أثناء التعديل."; console.error(err); });
        }
      });

      requestsTable.appendChild(row);
    });
  })
  .catch(err=>{
    errorEl.textContent="❌ حدث خطأ أثناء تحميل الطلبات.";
    console.error(err);
  });
}

// إضافة طلب جديد من لوحة الإدارة
addRequestBtn.addEventListener("click", ()=>{
  const name = prompt("اسم الطالب الجديد:");
  const phone = prompt("رقم الهاتف:");
  if(name && phone){
    const uid = db.ref("pendingStudents").push().key;
    db.ref("pendingStudents/"+uid).set({name, phone, timestamp:Date.now()})
    .then(()=>{ statusEl.textContent=`✅ تم إضافة ${name} بنجاح`; loadRequests(); })
    .catch(err=>{ errorEl.textContent="❌ حدث خطأ أثناء إضافة الطلب."; console.error(err); });
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Firebase</title>
<style>
body {
  background: #121212; color: #fff; font-family: 'Cairo', sans-serif;
  text-align: center; padding: 20px;
}
select, button {
  padding: 8px 12px; border-radius: 6px; border: none; font-size: 15px;
}
select { width: 200px; margin: 5px; background: #222; color: #fff; }
button {
  background: #f36; color: #fff; cursor: pointer;
}
button:hover { background: #ff4d4d; }

table {
  width: 95%; margin: 20px auto; border-collapse: collapse;
}
th, td {
  border: 1px solid #444; padding: 8px;
}
th { background: #222; color: #ffd700; }
td input {
  width: 90%; padding: 6px; border-radius: 5px; border: none;
  background: #222; color: #fff;
}
#log {
  margin-top: 20px; text-align: left; max-width: 700px; margin-inline: auto;
  background: #1a1a1a; padding: 15px; border-radius: 10px; white-space: pre-wrap;
}
</style>
</head>
<body>

<h2>ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Firebase</h2>

<div>
  <select id="teacherSelect">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³</option>
  </select>
  <select id="chapterSelect">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨</option>
  </select>
  <button id="filterBtn">Ø¨Ø­Ø« ğŸ”</button>
  <button id="showAllBtn" style="background:#28a745;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ ğŸŒ</button>
</div>

<table id="videosTable">
  <thead>
    <tr>
      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
      <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
      <th>Ø§Ù„Ø¨Ø§Ø¨</th>
      <th>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
      <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</th>
      <th>ØªØ­Ø¯ÙŠØ«</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr><td colspan="6" style="text-align:center; color:#ffd700;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…...</td></tr>
  </tbody>
</table>

<div id="log"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdhj73cKJc2J2_tDHw2-89EemZx-EGMJQ",
  authDomain: "alamer-526ff.firebaseapp.com",
  databaseURL: "https://alamer-526ff-default-rtdb.firebaseio.com",
  projectId: "alamer-526ff",
  storageBucket: "alamer-526ff.firebasestorage.app",
  messagingSenderId: "523879269039",
  appId: "1:523879269039:web:634861aa34641bfebf8a5a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const teacherSelect = document.getElementById("teacherSelect");
const chapterSelect = document.getElementById("chapterSelect");
const filterBtn = document.getElementById("filterBtn");
const showAllBtn = document.getElementById("showAllBtn");
const tableBody = document.getElementById("tableBody");
const logBox = document.getElementById("log");

function log(msg) {
  logBox.textContent += msg + "\n";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
async function loadFilters() {
  try {
    const snap = await get(ref(db, "videos"));
    if (!snap.exists()) return;
    const data = snap.val();

    const teachers = new Set();
    const chapters = new Map(); // teacher -> [chapters]

    Object.values(data).forEach(v => {
      if (v.teacher) {
        teachers.add(v.teacher);
        if (!chapters.has(v.teacher)) chapters.set(v.teacher, new Set());
        if (v.chapter) chapters.get(v.teacher).add(v.chapter);
      }
    });

    teacherSelect.innerHTML = <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³</option>;
    teachers.forEach(t => {
      teacherSelect.innerHTML += <option value="${t}">${t}</option>;
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³
    teacherSelect.onchange = () => {
      chapterSelect.innerHTML = <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¨</option>;
      const teacher = teacherSelect.value;
      if (chapters.has(teacher)) {
        chapters.get(teacher).forEach(ch => {
          chapterSelect.innerHTML += <option value="${ch}">${ch}</option>;
        });
      }
    };

    tableBody.innerHTML = <tr><td colspan="6" style="text-align:center; color:#ffd700;">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³ ÙˆØ¨Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· "Ø¨Ø­Ø«"</td></tr>;
  } catch (e) {
    log("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…:\n" + e);
  }
}

async function loadVideos(filter = {}) {
  logBox.textContent = "";
  tableBody.innerHTML = <tr><td colspan="6" style="text-align:center;color:#ffd700;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>;
  try {
    const snap = await get(ref(db, "videos"));
    if (!snap.exists()) {
      tableBody.innerHTML = <tr><td colspan="6">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</td></tr>;
      return;
    }

    const data = snap.val();
    const filtered = Object.entries(data).filter(([id, v]) => {
      return (!filter.teacher || v.teacher === filter.teacher) &&
             (!filter.chapter || v.chapter === filter.chapter);
    });

    if (filtered.length === 0) {
      tableBody.innerHTML = <tr><td colspan="6">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>;
      return;
    }

    tableBody.innerHTML = "";
    filtered.forEach(([id, v]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</td>
        <td>${v.subject || "-"}</td>
        <td>${v.chapter || "-"}</td>
        <td><a href="${v.url}" target="_blank" style="color:#ffd700;">Ø±Ø§Ø¨Ø·</a></td>
        <td><input id="lec-${id}" value="${v.lecture || ""}" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù‡Ù†Ø§"></td>
        <td><button id="btn-${id}" style="background:#28a745;">ØªØ­Ø¯ÙŠØ«</button></td>
      `;
      tableBody.appendChild(tr);

      document.getElementById(btn-${id}).onclick = async () => {
        const newLecture = document.getElementById(lec-${id}).value.trim();
        if (!newLecture) return alert("âš  Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹");
        await update(ref(db, videos/${id}), { lecture: newLecture });
        log(âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${id} â†’ ${newLecture});
        alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
      };
    });

  } catch (err) {
    log("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n" + err);
  }
}

filterBtn.onclick = () => {
  const teacher = teacherSelect.value;
  const chapter = chapterSelect.value;
  if (!teacher || !chapter) return alert("âš  Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³ ÙˆØ¨Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹");
  loadVideos({ teacher, chapter });
};

showAllBtn.onclick = () => loadVideos();

loadFilters();
</script>
</body>
</html>
